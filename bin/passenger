#!/bin/bash

# Default to production mode
PASSENGER_ENVIRONMENT="production"

# Make log/, tmp/pids/
mkdir -p log && mkdir -p tmp/pids

# Restart application after every request in development mode
if [ "$APPLICATION_ENV" == "dev" ]; then
    touch tmp/always_restart.txt
    PASSENGER_ENVIRONMENT="development"
fi

# Configure Passenger, as per https://www.phusionpassenger.com/library/config/standalone/reference/
PASSENGER_ENVIRONMENT="$PASSENGER_ENVIRONMENT" \
PASSENGER_LOG_FILE=log/passenger.log \
PASSENGER_NGINX_CONFIG_TEMPLATE=/usr/local/etc/nginx.conf.erb \
PASSENGER_PORT=8080 \
PASSENGER_PYTHON=/opt/pyenv/shims/python3.6 \
PASSENGER_TURBOCACHING=false \
/opt/rbenv/shims/passenger "$@"

# Remove tmp/always_restart.txt in development mode
if [ "$APPLICATION_ENV" == "dev" ]; then
    rm -f tmp/always_restart.txt
fi

# Remove tmp/pids
rm -f tmp/pids/passenger.*.pid && rm -f tmp/pids/passenger.*.pid.lock && rmdir tmp/pids && rmdir tmp
