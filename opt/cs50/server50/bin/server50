#!/bin/bash

restart() {
    if [ $# -ne 0 ]; then
        usage
        return 1
    fi
    stop
    start $(</var/opt/cs50/server50/start)
}

start() {

    if [ $# -eq 0 -o $# -gt 2 ]; then
        usage "$1"
        return 1
    fi

    if [ -f "/var/opt/cs50/server50/start" ]; then
        echo "CS50 Server is already running"
        return 1
    fi

    local root=$(readlink -f "$1")
    local port=80
    if [ ! -d "$root" ]; then
        echo "No such directory: $root"
        return 1
    fi

    rm -f /var/opt/cs50/server50/*

    # environment variables

    if [ "$APPLICATION_ENV" == "dev" ]; then
        php5enmod xdebug && \
        cp -f /etc/opt/cs50/server50/php5/php.ini-development /var/opt/cs50/server50/php.ini
    else
        php5dismod xdebug && \
        cp -f /etc/opt/cs50/server50/php5/php.ini-production /var/opt/cs50/server50/php.ini
    fi

    cat /opt/cs50/server50/var/nginx/php.conf | port="$port" root="$root" envsubst '${port}:${root}' > /var/opt/cs50/server50/default

    local env=$(env | sort | sed 's/\([^=]\+\)=\(.*\)/env[\1]=\"\2\"/' | awk 'length <= 1024')
    cat /opt/cs50/server50/var/php5/fpm/www.conf | env="$env" envsubst '${env}' > /var/opt/cs50/server50/www.conf

    cat /opt/cs50/server50/var/supervisor/supervisord.conf | files="/etc/opt/cs50/server50/supervisor/php.conf" envsubst '${files}' > /var/opt/cs50/server50/supervisord.conf
    APPLICATION_ENV=dev /opt/cs50/server50/bin/supervisord
    
    return 0

    # 
    echo "$@" > /var/opt/cs50/server50/start

    #sed -i "s#listen 80 default_server;#listen $port default_server;#" /etc/nginx/sites-enabled/php.conf

    APPLICATION_ENV=dev supervisord -c /etc/supervisor/supervisord.conf

}

status() {
    if [ "$#" -ne 0 ]; then
        usage "$1"
        return 1
    fi
    echo TODO
}

stop() {
    if [ $# -ne 0 ]; then
        usage "$1"
        return 1
    fi
    /opt/cs50/server50/bin/supervisorctl shutdown > /dev/null
    rm -f /var/opt/cs50/server50/*
    return 0
}

usage() {
    echo "Usage: server50 command options"
}


command="$1"
shift

case "$command" in
    help)
        usage
        exit 0
    ;;
    restart)
        restart
    ;;
    start)

        if start "$@"; then
            echo "Started CS50 Server"
            exit 0
        else
            exit 1
        fi
    ;;
    status)
        status "$@"
    ;;
    stop)
        if stop "$@"; then
            echo "Stopped CS50 Server"
            exit 0
        else
            exit 1
        fi
    ;;
    *)
        usage
        exit 1
    ;;
esac
